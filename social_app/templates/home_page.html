<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feed | GatorNet</title>
    {% load static %}
    {% load custom_filters %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    <link rel="stylesheet" href="{% static 'css/home.css' %}" />
  </head>

  <body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-green-700 p-4 flex items-center" id="navbar">
      <div class="rounded-full flex items-center justify-center">
        <img src="{% static 'img/logo.png' %}" id="logo" class="h-12 w-12" alt="Logo" />
      </div>
      <form action="{% url 'search' %}" method="post">
        {% csrf_token %}
        <input type="search" placeholder="Search" name="search" class="flex w-[50vh] p-2 rounded-full border-2 border-gray-600" id="search" />
        <button type="submit" hidden></button>
      </form>
      <div>
        <a href="{% url 'view_profile' user.id %}" class="text-white px-4 py-2 ml-4 rounded font-bold hover:text-gray-300 transition-colors duration-200">My Profile</a>
        <button class="text-white bg-green-800 px-4 py-0 ml-4 rounded hover:bg-green-900" id="button">Log Out</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex">
      <!-- Left Content -->
      <div class="w-3/4 mx-auto bg-white shadow-md rounded-lg p-6 overflow-y-auto">
        <!-- Create Post -->
        <form action="{% url 'create_post' %}" method="post">
          {% csrf_token %}
          <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
            <div class="flex items-center mb-4">
              <a href="{% url 'view_profile' user.id %}"><img src="{% if user.profile_picture.url %} {{ user.profile_picture.url }} {% else %} {% static 'imgs/default-profile.png' %} {% endif %}" alt="Profile" class="h-12 w-12 rounded-full border-2 border-gray-300" /></a>
              <textarea name='content' placeholder="What are you thinking about?" class="ml-4 flex-grow p-2 border rounded-lg focus:border-green-700 focus:outline-none"></textarea>
            </div>
            {% for message in messages %}
              {% if 'create_post' in message.tags %}
                <p class="text-red-500 text-sm font-medium" id="message-error">{{ message }}</p>
              {% endif %}
            {% endfor %}
            <div class="text-right">
              <button class="bg-green-700 text-white px-6 py-0 rounded shadow hover:bg-green-600 transition" id="button">Post</button>
            </div>
            <input type="hidden" name="current_view" value="home">
          </div>
        </form>

        <!-- Posts -->
        {% for item in posts_with_likes %}
        <div class="bg-gray-50 p-4 rounded-lg shadow mb-6 post-container">
          {% if item.post.shared %}
            <p class="text-gray-700 mb-4 border-b pb-[0.7vh] border-gray-600"><span class="font-bold">{{ item.post.creator.full_name }}</span> shared <span class="font-bold">{% if item.post.creator == item.shared_post.creator %} his own post.{% else %} {{ item.shared_post.creator.full_name }}'s</span> post.{% endif %}</p>
          {% endif %}
          <div class="flex items-center mb-2">
            <a href="{% url 'view_profile' item.post.creator.id %}"><img src="{% if item.post.shared %} {{ item.shared_post.creator.profile_picture.url }} {% else %} {{ item.post.creator.profile_picture.url }} {% endif %}" alt="Profile" class="h-12 w-12 rounded-full border-2 border-gray-300" /></a>
            <div class="ml-4">
              <h3 class="font-bold"><a href="{% url 'view_profile' item.post.creator.id %}">{% if item.post.shared %} {{ item.shared_post.creator.full_name }} {% else %} {{ item.post.creator.full_name }} {% endif %}</a></h3>
              <p class="text-gray-500 text-sm">{{ item.post.created_at|timesince }} ago</p>
            </div>
          </div>
          <p class="text-gray-700 mb-4"><a href="{% url 'view_post' item.post.id %}">{{ item.post.content }}</a></p>
          <div class="flex items-center justify-between text-gray-700">
            <p class="text-sm">
              <span class="font-bold text-green-700 like-count"><a href="{% url 'view_post' item.post.id %}">{{ item.post.likes.count|abbreviate_number }} likes </span> | {{ item.post.comments.count|abbreviate_number }} comments</a>
            </p>          
            <div class="flex items-center space-x-4">
              <button class="like-btn {% if item.has_liked %} text-green-700 {% else %} text-gray-700 hover:text-green-700 {% endif %}" data-post-id="{{ item.post.id }}">
                <i class="fas fa-thumbs-up"></i>
              </button>
                <button class="text-gray-700 hover:text-green-700"><a href="{% url 'view_post' item.post.id %}"><i class="fas fa-comment"></i></a></button>
              <form action="{% url 'share_post' %}" method="post">
                {% csrf_token %}
                <button class="text-gray-700 hover:text-green-700"><i class="fas fa-share"></i></button>
                <input type="hidden" name="post_id" value="{{ item.post.id }}">
                <input type="hidden" name="current_view" value="home">
              </form>
              {% if item.post.creator.id == request.session.user_id %}
                <button class="delete-post-btn text-gray-700 hover:text-red-600" data-post-id="{{ item.post.id }}">
                    <i class="fas fa-trash"></i>
                </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Right Sidebar -->
      <div class="w-1/4 bg-gray-50 border-l border-gray-200 p-4 overflow-y-auto">
        <h3 class="text-lg font-bold mb-4">Your Friends</h3>
        <ul>
          {% for friend in friends %}
            <li class="flex items-center space-x-4 py-2">
              <img src="{% if friend.profile_picture.url %} {{ friend.profile_picture.url }} {% else %} {% static 'imgs/default-profile.png' %} {% endif %}" alt="Profile" class="h-10 w-10 rounded-full" />
              <span class="text-gray-800 font-medium">{{ friend.first_name }} {{ friend.last_name }}</span>
            </li>
          {% empty %}
            <li class="text-gray-500">No friends yet.</li>
          {% endfor %}
        </ul>
      </div>
    </main>


    <!-- Footer -->
    <footer class="bg-green-700 text-white text-center py-4" id="bottomPage">
      <div class="space-x-4">
        <a href="#" class="text-blue-300 hover:underline">About Us</a>
        <span>|</span>
        <span>&copy; 2024 GatorNet. All Rights Reserved.</span>
      </div>
    </footer>
  </body>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
    $(".like-btn").click(function () {
        var postId = $(this).data('post-id');
        var likeButton = $(this);

        // Prevent multiple clicks
        if (likeButton.hasClass('loading')) return;
        likeButton.addClass('loading');

        // Send AJAX request
        $.ajax({
            url: "{% url 'like_post' %}",
            method: 'POST',
            data: {
                'post_id': postId,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function (response) {
                if (response.success) {
                    // Update the like count and button state
                    if (response.liked) {
                        likeButton.addClass('text-green-700');
                    } else {
                        likeButton.removeClass('text-green-700');
                    }

                    // Update like count
                    var postContainer = likeButton.closest('.post-container');
                    var likeCountLabel = postContainer.find('.like-count'); 
                    likeCountLabel.text(response.like_count + " likes");

                } else {
                    alert("Failed to like/unlike the post.");
                }
            },
            error: function () {
                alert("An error occurred. Please try again.");
            },
            complete: function () {
                likeButton.removeClass('loading');
            }
        });
    });
    $(".delete-post-btn").click(function () {
        var postId = $(this).data('post-id');
        var deleteButton = $(this);

        if (deleteButton.hasClass('loading')) return;
        deleteButton.addClass('loading');

        $.ajax({
            url: "{% url 'delete_post' %}",
            method: 'POST',
            data: {
                'post_id': postId,
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function (response) {
                if (response.success) {
                    deleteButton.closest('.post-container').remove();
                } else {
                    alert(response.error || "Failed to delete the post.");
                }
            },
            error: function () {
                alert("An error occurred. Please try again.");
            },
            complete: function () {
                deleteButton.removeClass('loading');
            }
        });
    });
});
  </script>
</html>
